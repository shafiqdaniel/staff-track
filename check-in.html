<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Track | Staff Check-in</title>
    <link rel="stylesheet" href="style.css">
    <style>
        .status-options {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .status-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #eee;
            border-radius: 12px;
            background: var(--white);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            color: var(--text-dark);
        }

        .status-btn.selected[data-status="In Office"] {
            border-color: #2ecc71;
            background: #e8f8f0;
            color: #27ae60;
        }

        .status-btn.selected[data-status="Remote"] {
            border-color: #3498db;
            background: #ebf5fb;
            color: #2980b9;
        }

        .status-btn.selected[data-status="On Event"] {
            border-color: #f1c40f;
            background: #fef9e7;
            color: #f39c12;
        }

        .checkin-card {
            max-width: 500px;
            margin: 50px auto;
        }

        .success-msg {
            display: none;
            background: #e8f8f0;
            color: #27ae60;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            text-align: center;
            font-weight: 600;
        }
    </style>
</head>

<body style="background: #f4f7f6; display: flex; align-items: center; justify-content: center; min-height: 100vh;">

    <div class="card checkin-card">
        <div class="modal-header"
            style="background: var(--primary-black); border-radius: 12px 12px 0 0; padding: 20px;">
            <h2 style="color: var(--white); margin:0; font-size: 20px;">Staff Check-in</h2>
        </div>

        <div style="padding: 30px;">
            <form id="checkinForm">
                <div class="form-group">
                    <label for="staffName">Select Your Name</label>
                    <select id="staffName" required>
                        <option value="">-- Loading Staff... --</option>
                    </select>
                </div>

                <label>Current Status</label>
                <div class="status-options">
                    <div class="status-btn" onclick="selectStatus(this)" data-status="In Office">In Office</div>
                    <div class="status-btn" onclick="selectStatus(this)" data-status="Remote">Remote</div>
                    <div class="status-btn" onclick="selectStatus(this)" data-status="On Event">On Event</div>
                </div>
                <input type="hidden" id="selectedStatus" required>

                <div class="form-group">
                    <label for="remarks">Location / Remarks</label>
                    <input type="text" id="remarks" placeholder="e.g. Meeting Room A or Stadium" required>
                </div>

                <button type="submit" class="add-btn" style="width: 100%; padding: 15px;">Submit Check-in</button>
            </form>

            <div id="successMsg" class="success-msg">
                Check-in Successful!
            </div>
        </div>
    </div>

    <!-- ===== FIREBASE SCRIPT ===== -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, where } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOxGlMtNCPXfd8_vAuIBfUgz1Fsn_Tr7Q",
            authDomain: "stafftrack-16a87.firebaseapp.com",
            projectId: "stafftrack-16a87",
            storageBucket: "stafftrack-16a87.firebasestorage.app",
            messagingSenderId: "555632662062",
            appId: "1:555632662062:web:7dd32f29027ff248e631bf"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const staffSelect = document.getElementById("staffName");
        const checkinForm = document.getElementById("checkinForm");
        const successMsg = document.getElementById("successMsg");

        // Fetch Staff List
        async function fetchStaff() {
            try {
                const q = query(collection(db, "users"), where("role", "==", "Staff"));
                const snapshot = await getDocs(q);
                staffSelect.innerHTML = '<option value="">-- Select Your Name --</option>';

                snapshot.forEach(docSnap => {
                    const data = docSnap.id == docSnap.id ? docSnap.data() : docSnap.data(); // Ensure data
                    const name = data.fullname;
                    const unit = data.unit || data.department || "No Unit";
                    const option = document.createElement("option");
                    option.value = JSON.stringify({ name, unit });
                    option.textContent = name + " (" + unit + ")";
                    staffSelect.appendChild(option);
                });

                if (snapshot.empty) {
                    staffSelect.innerHTML = '<option value="">No Staff Found</option>';
                }
            } catch (err) {
                console.error(err);
                staffSelect.innerHTML = '<option value="">Error Loading Staff</option>';
            }
        }

        fetchStaff();

        // Status Selection logic
        window.selectStatus = function (btn) {
            document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            document.getElementById("selectedStatus").value = btn.getAttribute('data-status');
        }

        // Handle Submit
        checkinForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const staffInfo = JSON.parse(staffSelect.value);
            const status = document.getElementById("selectedStatus").value;

            if (!status) {
                alert("Please select a status!");
                return;
            }

            const checkinData = {
                name: staffInfo.name,
                unit: staffInfo.unit,
                status: status,
                remarks: document.getElementById("remarks").value,
                date: new Date().toISOString().split('T')[0],
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, "availability"), checkinData);
                successMsg.style.display = "block";
                checkinForm.reset();
                document.querySelectorAll('.status-btn').forEach(b => b.classList.remove('selected'));
                setTimeout(() => { successMsg.style.display = "none"; }, 3000);
            } catch (err) {
                alert("Error during check-in: " + err.message);
            }
        });
    </script>
</body>

</html>