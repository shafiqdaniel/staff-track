<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Staff Track | User Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <h1>Staff Track â€“ User Management</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">

        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="ncer-logo.png" alt="NCER Logo" class="sidebar-logo">
            </div>
            <a href="dashboard.html">Dashboard</a>
            <a href="availability.html">Staff Availability</a>
            <a href="staff.html">Staff Management</a>
            <a href="report.html">Reports</a>
            <a href="user-management.html" class="active">User Management</a>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="section-title">
                <h2>User Management</h2>
            </div>

            <div class="user-grid">

                <!-- ADD NEW USER -->
                <div class="card" style="padding:0; overflow:hidden;">
                    <div class="modal-header" style="background: var(--primary-black); padding: 15px 25px;">
                        <h3 style="color: var(--white); margin:0;">Add New User</h3>
                    </div>
                    <div style="padding: 25px;">

                        <form id="addUserForm">
                            <div class="form-group">
                                <label>Full Name</label>
                                <input type="text" id="userName" placeholder="e.g. Aina Hassan" required>
                            </div>

                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" id="userEmail" placeholder="user@stafftrack.com" required>
                            </div>

                            <div class="form-group">
                                <label>Role</label>
                                <select id="userRole" required>
                                    <option value="Admin">Admin</option>
                                    <option value="Staff">Staff</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label>Unit</label>
                                <select id="userUnit" required>
                                    <option value="">-- Select Unit --</option>
                                    <option value="Media Reputation Management">Media Reputation Management</option>
                                    <option value="Events Management">Events Management</option>
                                    <option value="Creative & Branding Management">Creative & Branding Management
                                    </option>
                                </select>
                            </div>

                            <button type="submit" class="add-btn">Add User</button>
                        </form>
                    </div>
                </div>

                <!-- USER LIST -->
                <div class="table-container">
                    <div class="modal-header" style="background: #fafafa; border-bottom: 1px solid #eee;">
                        <h3 style="color: var(--text-dark); margin:0;">User List</h3>
                    </div>

                    <table id="userTable">
                        <thead>
                            <tr>
                                <th class="col-name">Name</th>
                                <th>Email</th>
                                <th class="col-status">Role</th>
                                <th class="col-unit">Unit</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>

            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOxGlMtNCPXfd8_vAuIBfUgz1Fsn_Tr7Q",
            authDomain: "stafftrack-16a87.firebaseapp.com",
            projectId: "stafftrack-16a87",
            storageBucket: "stafftrack-16a87.firebasestorage.app",
            messagingSenderId: "555632662062",
            appId: "1:555632662062:web:7dd32f29027ff248e631bf"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const addUserForm = document.getElementById("addUserForm");
        const userTableBody = document.querySelector("#userTable tbody");

        // Protect page
        onAuthStateChanged(auth, user => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                listenToUsers();
            }
        });

        // Fetch Users Real-time
        function listenToUsers() {
            // Simplified query to avoid index requirement for now
            const q = query(collection(db, "users"));
            onSnapshot(q, (snapshot) => {
                userTableBody.innerHTML = "";
                snapshot.forEach((docSnap) => {
                    const userData = docSnap.data();
                    const id = docSnap.id;
                    const roleClass = userData.role === "Admin" ? "role-admin" : "role-staff";

                    const row = `
                        <tr>
                            <td class="col-name">${userData.fullname}</td>
                            <td>${userData.email}</td>
                            <td class="col-status"><span class="${roleClass}">${userData.role}</span></td>
                            <td class="col-unit">${userData.unit || '-'}</td>
                            <td>
                                <button class="action-btn delete-btn" onclick="deleteUser('${id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                    userTableBody.innerHTML += row;
                });

                if (snapshot.empty) {
                    userTableBody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No users found.</td></tr>";
                }
            });
        }

        // Add User
        addUserForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const userData = {
                fullname: document.getElementById("userName").value,
                email: document.getElementById("userEmail").value,
                role: document.getElementById("userRole").value,
                unit: document.getElementById("userUnit").value,
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, "users"), userData);
                addUserForm.reset();
            } catch (err) {
                alert("Error adding user: " + err.message);
            }
        });

        // Delete User
        window.deleteUser = async (id) => {
            if (confirm("Are you sure you want to delete this user?")) {
                try {
                    await deleteDoc(doc(db, "users", id));
                } catch (err) {
                    alert("Error deleting: " + err.message);
                }
            }
        }

        window.logout = async function () {
            try {
                await signOut(auth);
                window.location.href = "login.html";
            } catch (error) {
                console.error("Logout Error:", error);
                alert("Error logging out: " + error.message);
            }
        }
    </script>
</body>

</html>