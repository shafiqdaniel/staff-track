<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Staff Track | Reports</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <h1>Staff Track â€“ Reports</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">

        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="ncer-logo.png" alt="NCER Logo" class="sidebar-logo">
            </div>
            <a href="dashboard.html">Dashboard</a>
            <a href="availability.html">Staff Availability</a>
            <a href="staff.html">Staff Management</a>
            <a href="report.html" class="active">Reports</a>
            <a href="user-management.html">User Management</a>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <h2>Staff Availability Reports</h2>

            <!-- FILTER -->
            <div class="filter-box">
                <form id="reportForm">
                    <div class="filter-group">
                        <label for="startDate">Start Date</label>
                        <input type="date" id="startDate">
                    </div>

                    <div class="filter-group">
                        <label for="endDate">End Date</label>
                        <input type="date" id="endDate">
                    </div>

                    <div class="filter-group">
                        <label for="unitSelect">Unit</label>
                        <select id="unitSelect">
                            <option value="">All Units</option>
                            <option value="Media Reputation Management">Media Reputation Management</option>
                            <option value="Events Management">Events Management</option>
                            <option value="Creative & Branding Management">Creative & Branding Management</option>
                        </select>
                    </div>

                    <div class="filter-actions">
                        <button type="submit" class="generate-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                        <button type="reset" class="reset-btn">Reset</button>
                    </div>
                </form>
            </div>

            <!-- ANALYTICS CHART -->
            <div id="chartSection" class="chart-section" style="display:none;">
                <div class="chart-title">Status Distribution</div>
                <div class="chart-container">
                    <canvas id="statusChart"></canvas>
                </div>
            </div>

            <!-- SUMMARY -->
            <div class="cards">
                <div class="card">
                    <h3>Total Records</h3>
                    <p id="totalRecords">0</p>
                </div>

                <div class="card">
                    <h3>In Office</h3>
                    <p id="inOfficeRecords">0</p>
                </div>

                <div class="card">
                    <h3>Outside Office</h3>
                    <p id="outsideOfficeRecords">0</p>
                </div>

                <div class="card">
                    <h3>Medical</h3>
                    <p id="medicalRecords">0</p>
                </div>
            </div>

            <!-- TABLE -->
            <div class="table-container">
                <table id="reportTable">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th class="col-name">Name</th>
                            <th class="col-unit">Unit</th>
                            <th class="col-status">Status</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>

        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js";
        import { getFirestore, collection, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js";

        // Firebase Configuration (Same as others)
        const firebaseConfig = {
            apiKey: "AIzaSyCOxGlMtNCPXfd8_vAuIBfUgz1Fsn_Tr7Q",
            authDomain: "stafftrack-16a87.firebaseapp.com",
            projectId: "stafftrack-16a87",
            storageBucket: "stafftrack-16a87.firebasestorage.app",
            messagingSenderId: "555632662062",
            appId: "1:555632662062:web:7dd32f29027ff248e631bf"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const reportForm = document.getElementById("reportForm");
        const tbody = document.querySelector("#reportTable tbody");
        let statusChart = null; // Store chart instance

        // Helper to normalize the mobile app's "dd/MM/yyyy" date format
        function parseDate(dateStr) {
            if (!dateStr) return null;
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                return new Date(parts[2], parts[1] - 1, parts[0]);
            }
            return new Date(dateStr); // Standard "yyyy-MM-dd"
        }

        // Protect page
        onAuthStateChanged(auth, user => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                // Set default dates to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById("startDate").value = today;
                document.getElementById("endDate").value = today;

                generateReport(); // Initial load
            }
        });

        reportForm.addEventListener("submit", (e) => {
            e.preventDefault();
            generateReport();
        });

        reportForm.addEventListener("reset", () => {
            setTimeout(generateReport, 10);
        });

        async function generateReport() {
            const startDateVal = document.getElementById("startDate").value;
            const endDateVal = document.getElementById("endDate").value;
            const unit = document.getElementById("unitSelect").value;

            const startLimit = startDateVal ? new Date(startDateVal + "T00:00:00") : null;
            const endLimit = endDateVal ? new Date(endDateVal + "T23:59:59") : null;

            try {
                // Fetch all records ordered by newest first
                // We handle filtering locally to avoid "Missing Index" errors
                const q = query(collection(db, "availability"), orderBy("createdAt", "desc"));
                const snapshot = await getDocs(q);

                tbody.innerHTML = "";

                let total = 0;
                let inOffice = 0;
                let outsideOffice = 0;
                let medical = 0;

                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    const recordDate = parseDate(data.date);

                    // Normalize the record's unit and the filter
                    const recordUnit = (data.unit || data.department || "").trim().toLowerCase();
                    const filterUnit = (unit || "").trim().toLowerCase();

                    // 1. Filter by Unit (Flexible matching ignoring "Unit" and "Management")
                    if (unit) {
                        const noiseWords = ["unit", "management", "and", "&"];

                        const normalize = (str) => str.toLowerCase()
                            .split(/\s+/)
                            .filter(word => word && !noiseWords.includes(word))
                            .join(" ");

                        const normalizedRecord = normalize(data.unit || data.department || "");
                        const normalizedFilter = normalize(unit);

                        // If the core names match or one contains the other
                        const isMatch = normalizedRecord.includes(normalizedFilter) ||
                            normalizedFilter.includes(normalizedRecord);

                        if (!isMatch && normalizedRecord !== normalizedFilter) return;
                    }

                    // 2. Filter by Date range
                    if (startLimit && recordDate && recordDate.getTime() < startLimit.getTime()) return;
                    if (endLimit && recordDate && recordDate.getTime() > endLimit.getTime()) return;

                    total++;
                    const status = data.status ? data.status.trim() : "";

                    // Count based on normalized status names
                    if (status === "In Office") {
                        inOffice++;
                    } else if (status === "Medical") {
                        medical++;
                    } else if (status === "Remote" || status === "Outside Office" || status === "Outstation" || status === "On Leave" || status === "On Event" || status === "Meeting") {
                        outsideOffice++;
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td>${data.date}</td>
                            <td class="col-name">${data.name}</td>
                            <td class="col-unit">${data.unit || data.department || "-"}</td>
                            <td class="col-status"><span class="status-badge ${status.toLowerCase().replace(/\s+/g, '-')}">${status}</span></td>
                            <td>${data.remarks || "-"}</td>
                        </tr>
                    `;
                });

                // Update summary cards
                document.getElementById("totalRecords").innerText = total;
                document.getElementById("inOfficeRecords").innerText = inOffice;
                document.getElementById("outsideOfficeRecords").innerText = outsideOffice;
                document.getElementById("medicalRecords").innerText = medical;

                if (total === 0) {
                    tbody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No records found matching your criteria.</td></tr>";
                    document.getElementById("chartSection").style.display = "none";
                } else {
                    document.getElementById("chartSection").style.display = "flex";
                    updateStatusChart(inOffice, outsideOffice, medical);
                }

            } catch (err) {
                console.error("Error generating report:", err);
                alert("Could not load report. Please check your internet connection.");
            }
        }

        function updateStatusChart(inOffice, outsideOffice, medical) {
            const ctx = document.getElementById('statusChart').getContext('2d');

            if (statusChart) {
                statusChart.destroy();
            }

            statusChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['In Office', 'Outside Office', 'Medical'],
                    datasets: [{
                        data: [inOffice, outsideOffice, medical],
                        backgroundColor: [
                            '#00aa00', // Green
                            '#00479e', // Blue
                            '#e60012'  // Red
                        ],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    family: "'Poppins', sans-serif",
                                    size: 12
                                }
                            }
                        }
                    },
                    cutout: '70%'
                }
            });
        }

        window.logout = async function () {
            try {
                await signOut(auth);
                window.location.href = "login.html";
            } catch (error) {
                console.error("Logout Error:", error);
                alert("Error logging out.");
            }
        }
    </script>
</body>

</html>