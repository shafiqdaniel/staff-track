<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Staff Track | Staff Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <!-- HEADER -->
    <div class="header">
        <h1>Staff Track â€“ Staff Management</h1>
        <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <div class="container">

        <!-- SIDEBAR -->
        <div class="sidebar">
            <div class="sidebar-header">
                <img src="ncer-logo.png" alt="NCER Logo" class="sidebar-logo">
            </div>
            <a href="dashboard.html">Dashboard</a>
            <a href="availability.html">Staff Availability</a>
            <a href="staff.html" class="active">Staff Management</a>
            <a href="report.html">Reports</a>
            <a href="user-management.html">User Management</a>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <div class="top-bar">
                <div class="top-left">
                    <h2>Staff List</h2>
                    <div class="search-container">
                        <input type="text" id="staffSearch" placeholder="Search staff name or email..."
                            onkeyup="filterStaff()">
                    </div>
                </div>
                <button class="add-btn" id="openModal">+ Add New Staff</button>
            </div>

            <div class="table-container">
                <table id="staffTable">
                    <thead>
                        <tr>
                            <th class="col-name">Name</th>
                            <th class="col-unit">Unit</th>
                            <th>Email</th>
                            <th class="col-status">Role</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div id="loading" style="text-align:center; padding: 20px;">Loading staff...</div>
        </div>
    </div>

    <!-- ADD STAFF MODAL -->
    <div id="addStaffModal" class="success-popup" style="display:none;">
        <div class="popup-content staff-modal">
            <div class="modal-header">
                <h3>Add New Staff</h3>
                <span class="close-x" id="closeModalX">&times;</span>
            </div>
            <form id="addStaffForm">
                <div class="form-group">
                    <label>Full Name</label>
                    <input type="text" id="staffName" placeholder="e.g. Aina Hassan" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="staffEmail" placeholder="admin@stafftrack.com" required>
                </div>
                <div class="form-group">
                    <label>Unit</label>
                    <select id="staffUnit" required>
                        <option value="">-- Select Unit --</option>
                        <option value="Media Reputation Management">Media Reputation Management</option>
                        <option value="Events Management">Events Management</option>
                        <option value="Creative & Branding Management">Creative & Branding Management</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" id="closeModal" class="reset-btn">Cancel</button>
                    <button type="submit" class="add-btn">Add Staff</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.1.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOxGlMtNCPXfd8_vAuIBfUgz1Fsn_Tr7Q",
            authDomain: "stafftrack-16a87.firebaseapp.com",
            projectId: "stafftrack-16a87",
            storageBucket: "stafftrack-16a87.firebasestorage.app",
            messagingSenderId: "555632662062",
            appId: "1:555632662062:web:7dd32f29027ff248e631bf"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const staffTableBody = document.querySelector("#staffTable tbody");
        const loading = document.getElementById("loading");
        const modal = document.getElementById("addStaffModal");
        const addStaffForm = document.getElementById("addStaffForm");

        // Protect page
        onAuthStateChanged(auth, user => {
            if (!user) {
                window.location.href = "login.html";
            } else {
                listenToStaff();
            }
        });

        // Modal Controls
        document.getElementById("openModal").addEventListener("click", () => modal.style.display = "flex");
        document.getElementById("closeModal").addEventListener("click", () => modal.style.display = "none");
        document.getElementById("closeModalX").addEventListener("click", () => modal.style.display = "none");

        // Search Logic
        window.filterStaff = function () {
            const input = document.getElementById("staffSearch").value.toLowerCase();
            const rows = staffTableBody.getElementsByTagName("tr");

            for (let i = 0; i < rows.length; i++) {
                const name = rows[i].getElementsByTagName("td")[0]?.textContent.toLowerCase() || "";
                const email = rows[i].getElementsByTagName("td")[2]?.textContent.toLowerCase() || "";
                if (name.includes(input) || email.includes(input)) {
                    rows[i].style.display = "";
                } else {
                    rows[i].style.display = "none";
                }
            }
        };

        // Fetch Staff Real-time
        function listenToStaff() {
            const q = query(collection(db, "users"), where("role", "==", "Staff"));
            onSnapshot(q, (snapshot) => {
                staffTableBody.innerHTML = "";
                loading.style.display = snapshot.empty ? "none" : "none";

                if (snapshot.empty) {
                    staffTableBody.innerHTML = "<tr><td colspan='5' style='text-align:center;'>No staff members found.</td></tr>";
                }

                snapshot.forEach((docSnap) => {
                    const staff = docSnap.data();
                    const id = docSnap.id;
                    const row = `
                        <tr>
                            <td class="col-name">${staff.fullname}</td>
                            <td class="col-unit">${staff.unit || staff.department || '-'}</td>
                            <td>${staff.email}</td>
                            <td class="col-status"><span class="role-staff">Staff</span></td>
                            <td>
                                <button class="action-btn delete-btn" onclick="deleteStaff('${id}')">Delete</button>
                            </td>
                        </tr>
                    `;
                    staffTableBody.innerHTML += row;
                });
            });
        }

        // Add Staff
        addStaffForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const staffData = {
                fullname: document.getElementById("staffName").value,
                email: document.getElementById("staffEmail").value,
                unit: document.getElementById("staffUnit").value,
                role: "Staff",
                createdAt: new Date()
            };

            try {
                await addDoc(collection(db, "users"), staffData);
                modal.style.display = "none";
                addStaffForm.reset();
            } catch (err) {
                alert("Error adding staff: " + err.message);
            }
        });

        // Delete Staff (Global for onclick)
        window.deleteStaff = async (id) => {
            if (confirm("Are you sure you want to delete this staff member?")) {
                try {
                    await deleteDoc(doc(db, "users", id));
                } catch (err) {
                    alert("Error deleting: " + err.message);
                }
            }
        }

        window.logout = async function () {
            try {
                await signOut(auth);
                window.location.href = "login.html";
            } catch (error) {
                console.error("Logout Error:", error);
                alert("Error logging out: " + error.message);
            }
        }
    </script>
</body>

</html>